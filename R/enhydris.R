# Enhydris API -----------------------------------------------------------------

# Examples
# PoliticalDivision	"http://kyy.hydroscope.gr/api/PoliticalDivision/?format=json"
# GentityAltCodeType	"http://kyy.hydroscope.gr/api/GentityAltCodeType/?format=json"
# Timeseries	"http://kyy.hydroscope.gr/api/Timeseries/?format=json"
# Person	"http://kyy.hydroscope.gr/api/Person/?format=json"
# TimeStep	"http://kyy.hydroscope.gr/api/TimeStep/?format=json"
# WaterDivision	"http://kyy.hydroscope.gr/api/WaterDivision/?format=json"
# Gpoint	"http://kyy.hydroscope.gr/api/Gpoint/?format=json"
# Overseer	"http://kyy.hydroscope.gr/api/Overseer/?format=json"
# TimeZone	"http://kyy.hydroscope.gr/api/TimeZone/?format=json"
# GentityEvent	"http://kyy.hydroscope.gr/api/GentityEvent/?format=json"
# Organization	"http://kyy.hydroscope.gr/api/Organization/?format=json"
# GentityAltCode	"http://kyy.hydroscope.gr/api/GentityAltCode/?format=json"
# IntervalType	"http://kyy.hydroscope.gr/api/IntervalType/?format=json"
# WaterBasin	"http://kyy.hydroscope.gr/api/WaterBasin/?format=json"
# GentityFile	"http://kyy.hydroscope.gr/api/GentityFile/?format=json"
# StationType	"http://kyy.hydroscope.gr/api/StationType/?format=json"
# Gentity	"http://kyy.hydroscope.gr/api/Gentity/?format=json"
# Gline	"http://kyy.hydroscope.gr/api/Gline/?format=json"
# FileType	"http://kyy.hydroscope.gr/api/FileType/?format=json"
# EventType	"http://kyy.hydroscope.gr/api/EventType/?format=json"
# Variable	"http://kyy.hydroscope.gr/api/Variable/?format=json"
# Instrument	"http://kyy.hydroscope.gr/api/Instrument/?format=json"
# Lentity	"http://kyy.hydroscope.gr/api/Lentity/?format=json"
# InstrumentType	"http://kyy.hydroscope.gr/api/InstrumentType/?format=json"
# UnitOfMeasurement	"http://kyy.hydroscope.gr/api/UnitOfMeasurement/?format=json"
# Garea	"http://kyy.hydroscope.gr/api/Garea/?format=json"
# Station	"http://kyy.hydroscope.gr/api/Station/?format=json"

# Single Station "http://kyy.hydroscope.gr/api/Station/200171/?format=json"
# Single timeseries "http://kyy.hydroscope.gr/api/Timeseries/259/?format=json"
# raw data "http://kyy.hydroscope.gr/api/tsdata/259/


# create url
hydroscope_url <- function(domain) {
  return(paste0("http://", domain, ".hydroscope.gr"))
}

# use Enhydris API to get json data
enhy_get_df <- function(h_url) {
  jsonlite::fromJSON(h_url, flatten=TRUE)
}

# use Enhydris API to get plain text data
enhy_get_txt <- function(h_url) {

  # read timeseries data
  tmFormat <- "%Y-%m-%d %H:%M"

  # use readr to get values
  readr::read_csv(url(h_url),
                  col_names = c("Date", "Value", "Comment"),
                  col_types = list(
                    readr::col_datetime(format = tmFormat),
                    readr::col_double(),
                    readr::col_character()))
}

# create lat. and lon. from points
create_coords <- function(str) {
  str_split <- stringr::str_split(string = str, pattern = "[\\(  \\)]",
                                  simplify = TRUE)

  if(NCOL(str_split) == 5) {
    data.frame(long = as.numeric(str_split[, 3]),
               lat = as.numeric(str_split[, 4]))
  } else {
    data.frame(long = rep(NA, NROW(str)),
               lat = rep(NA, NROW(str)))
  }
}

# create water_basin, water_division and political_division values
get_names <- function(s_url,
                      variable = c("water_division",
                                   "water_basin",
                                   "political_division"),
                      result){

  # create url
  h_url <- switch(
    variable,
    water_basin = paste0(s_url, "/api/WaterBasin/?format=json"),
    water_division = paste0(s_url, "/api/WaterDivision/?format=json"),
    political_division = paste0(s_url, "/api/PoliticalDivision/?format=json")
  )

  get_values <- enhy_get_df(h_url)

  # merge values
  res <-  merge(result[variable], get_values[c("id", "name")], by.x = variable,
               by.y = "id", all.x = TRUE)
  res$name


}
